<!DOCTYPE html>


<head>
	<title>Two GLTF hands</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="shortcut icon" type="image/png" href="logo.png"/>
	<link rel="stylesheet" href="examples.css">
</head>


<body>
	<header>
		<h1>Two GLTF hands</h1>
		<h2>Prototype models of prosthetic GLTF hands</h2>
		<h3><a href="https://boytchev.github.io/virtual-prosthetics/">Virtual Prosthetics Examples</a></h3>
	</header>
	
	<script type="module">


	import * as Prosthetic from "../build/virtual-prosthetics.js";
	//import * as Prosthetic from "../src/virtual-prosthetics.js";
	import * as lil from "../libs/lil-gui.module.min.js";


	const PI = Math.PI;
	const sin = Math.sin;
	const cos = Math.cos;
	
	var data = {
			speed: 3,
			motion: true,
			rotation: true,
			grabbing: true,
		};
	
	var gui = new lil.GUI();
		gui.add( data, 'speed' ).min(0).max(6).step(0.2).name( 'Time speed' );
		gui.add( data, 'motion' ).name( 'Forward-backward' );
		gui.add( data, 'rotation' ).name( 'Palm rotation' );
		gui.add( data, 'grabbing' ).name( 'Finger flexing' );


	class Hand extends Prosthetic.Robot
	{
		constructor( isLeft = true )
		{
			super( );
	
			this.isLeft = isLeft;

			if( isLeft )
				this.palm = new Prosthetic.RoundPalm( true, '../assets/gltf/round-palm.glb' );
			else
				this.palm = new Prosthetic.RoundPalm( false, '../assets/gltf/round-palm.glb' );
			
			this.palm.attachToSlot( this );

			this.spread = [];
			for( var i=0; i<5; i++ )
				this.spread[i] = this.addFinger( i );
		}
		
		addFinger( slot )
		{
			var Finger = Prosthetic.RoundFinger, // shortcut
				Joint = Prosthetic.MotorZ, // shortcut
				spread;
				
			if( slot == 0 )
				spread = new Prosthetic.MotorY( -1, 1, 0, 0.25, 0.02 );
			else
				spread = new Prosthetic.MotorX( -0.3, 0.3, 0, 0, 0 );
						
			this.addChain( 
					spread.attachToSlot( this.palm, slot ),
					new Joint( 0, -PI/2, -PI/4, 0.2, 0.07 ),
					new Finger( '../assets/gltf/round-finger-8.glb', 0.8 ),
					new Joint( 0, -PI/2, -PI/4, 0.2, 0.07 ),
					new Finger( '../assets/gltf/round-finger-5.glb', 0.5 ),
					new Joint( 0, -PI/2, -PI/4, 0.2, 0.07 ),
					new Finger( '../assets/gltf/round-tip.glb', 0.5 ),
				);
				
			return spread;
		}		
		

		flexFinger( i, angle )
		{
			var motors = this.getMotors();
			
			motors[4*i+1].setAngle( -angle );
			motors[4*i+2].setAngle( -angle );
			motors[4*i+3].setAngle( -angle );
		}


		flexFingers( angle )
		{
			for( var i=0; i<5; i++ )
				this.flexFinger( i, angle );
		}
		
		
		spreadFinger( i, angle )
		{
			var motors = this.getMotors();
			
			motors[4*i].setAngle( this.palm.flip * angle );
		}


		spreadFingers( angle, includeThumb=false )
		{
			if( includeThumb )
			{
				this.spreadFinger( 0, 3*angle );
			}
			
			this.spreadFinger( 1,  1.0*angle );
			this.spreadFinger( 2,  0.3*angle );
			this.spreadFinger( 3, -0.3*angle );
			this.spreadFinger( 4, -1.0*angle );
		}
		
	}


	var A = new Hand( true ),
		B = new Hand( false );

	Prosthetic.setCameraPosition( 4, 2, -10 );
	Prosthetic.setCameraTarget( 0, 1.5, 0 );
	Prosthetic.setAnimation( loop );
	
	var time = 0;
	function loop( t, dT )
	{
		// increase speed
		time += data.speed*dT;

		// grabing with fingers
		var k = data.grabbing ? 0.5 + 0.5*sin(time) : 0.1;
		A.flexFingers( 1.5*k );
		B.flexFingers( 1.5*k );

		k = data.grabbing ? 0.5 + 0.5*sin(time) : 0.5;
		A.spreadFingers( 0.2-0.2*k );
		B.spreadFingers( 0.2-0.2*k );
		
		// adjusting thumbs
		k = data.grabbing ? 0.5 + 0.5*sin(time+1) : 1;
		A.spreadFinger( 0, k );
		B.spreadFinger( 0, k );

		// palm forward-backward motion
		k = data.motion ? sin(time+2.5) : 0;
		A.setPosition( -2+0.5*k, 1.5+0.5*k, -2*k);
		B.setPosition( 2-0.5*k, 1.5+0.5*k, -2*k);

		
		// palm rotation
		k = data.rotation ? 1 + sin(time+2) : 1.5;
		A.setRotation( -0.5*k, -0.8*k,  0.5*k );
		B.setRotation( -0.5*k,  0.8*k, -0.5*k );
	}


	</script>
</body>
